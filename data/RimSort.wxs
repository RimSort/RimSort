<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
    <Package Name="RimSort"
        Language="1033"
        Version="$(var.PackageVersion)"
        Manufacturer="RimSort Team"
        UpgradeCode="d4f7c3b9-8a5e-4e52-bb9f-3c2d1f7a9e24"
        InstallerVersion="500"
        Compressed="yes">

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <!-- Registry search for previous installation directory -->
        <Property Id="INSTALLFOLDER">
            <RegistrySearch Id="PreviousInstallDirSearch"
                Root="HKCU"
                Key="Software\RimSort"
                Name="InstallDir"
                Type="raw" />
        </Property>

        <!-- Application icon -->
        <Icon Id="RimSortIcon" SourceFile="themes\default-icons\AppIcon.ico" />
        <Property Id="ARPPRODUCTICON" Value="RimSortIcon" />

        <!-- Check if D drive exists -->
        <Property Id="D_PROGRAM_FILES_EXISTS">
            <DirectorySearch Id="CheckDProgramFiles" Path="D:\Program Files" Depth="0" AssignToProperty="yes" />
        </Property>

        <!-- Custom action to set install folder to D drive if available -->
        <CustomAction Id="SetInstallFolderToD"
            Property="INSTALLFOLDER"
            Value="D:\Program Files\RimSort"
            Execute="immediate" />

        <!-- Execute custom action during install sequence -->
        <InstallUISequence>
            <Custom Action="SetInstallFolderToD"
                Before="CostFinalize"
                Condition="D_PROGRAM_FILES_EXISTS AND NOT INSTALLFOLDER" />
        </InstallUISequence>

        <!-- Directory structure -->
        <StandardDirectory Id="ProgramFilesFolder">
            <Directory Id="INSTALLFOLDER" Name="RimSort" />
        </StandardDirectory>

        <!-- Alternative D drive directory structure -->
        <Directory Id="D_Drive" Name="D">
            <Directory Id="DProgramFilesFolder" Name="Program Files">
                <Directory Id="INSTALLFOLDER_D" Name="RimSort" />
            </Directory>
        </Directory>

        <!-- Start menu directory -->
        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="RimSort" />
        </StandardDirectory>

        <!-- Main application files component group -->
        <ComponentGroup Id="MainComponents" Directory="INSTALLFOLDER">
            <Files Include="..\build\__main__.dist\**" />
        </ComponentGroup>

        <!-- Feature definition -->
        <Feature Id="ProductFeature" Title="RimSort" Level="1">
            <ComponentGroupRef Id="MainComponents" />
            <ComponentGroupRef Id="ShortcutComponents" />
            <ComponentGroupRef Id="RegistryComponents" />
        </Feature>

        <!-- UI configuration - InstallDir and EULA -->
        <ui:WixUI Id="WixUI_InstallDir" />
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
        <WixVariable Id="WixUILicenseRtf" Value="$(var.License)" />

        <!-- Start menu shortcut components -->
        <ComponentGroup Id="ShortcutComponents" Directory="ApplicationProgramsFolder">
            <Component Id="StartMenuShortcut" Guid="3C5F5459-99AE-5A3E-0422-E64DA66B4443">
                <RegistryValue Root="HKCU"
                    Key="Software\RimSort"
                    Name="StartMenuShortcutInstalled"
                    Type="integer"
                    Value="1"
                    KeyPath="yes" />
                <Shortcut Id="ApplicationStartMenuShortcut"
                    Directory="ApplicationProgramsFolder"
                    Name="RimSort"
                    Target="[INSTALLFOLDER]RimSort.exe"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="RimSortIcon"
                    IconIndex="0" />
                <RemoveFolder Id="RemoveApplicationProgramsFolder"
                    Directory="ApplicationProgramsFolder"
                    On="uninstall" />
            </Component>
        </ComponentGroup>

        <!-- Registry components for installation tracking -->
        <ComponentGroup Id="RegistryComponents" Directory="INSTALLFOLDER">
            <Component Id="InstallFlagRegistry" Guid="92D579F1-DC10-4E2F-87F5-25B36476C271">
                <RegistryValue Root="HKCU"
                    Key="Software\RimSort\StartMenu"
                    Name="installed"
                    Type="integer"
                    Value="1"
                    KeyPath="yes" />
            </Component>
            <Component Id="InstallPathRegistry" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
                <RegistryValue Root="HKCU"
                    Key="Software\RimSort"
                    Name="InstallDir"
                    Type="string"
                    Value="[INSTALLFOLDER]"
                    KeyPath="yes" />
            </Component>
        </ComponentGroup>
    </Package>
</Wix>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
    xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
    xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

    <!-- ===================================================== -->
    <!-- Package Configuration -->
    <!-- ===================================================== -->

    <Package Name="RimSort" Language="1033" Version="$(PackageVersion)"
        Manufacturer="RimSort Team" UpgradeCode="d4f7c3b9-8a5e-4e52-bb9f-3c2d1f7a9e24"
        InstallerVersion="500" Compressed="yes">

        <!-- ===================================================== -->
        <!-- Upgrade and Error Handling -->
        <!-- ===================================================== -->

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
            AllowSameVersionUpgrades="yes" />
        <MediaTemplate EmbedCab="yes" />

        <!-- ===================================================== -->
        <!-- Properties and Configuration -->
        <!-- ===================================================== -->

        <!-- License file path for the installer UI -->
        <Property Id="WixUILicenseRtf" Value="$(License)" />

        <!-- Force complete reinstall like app is new - a=all files, e=even if not installed,
        c=recache source, m=missing files, u=user registry, s=shortcuts -->
        <Property Id="REINSTALLMODE" Value="aecmus" />

        <!-- ===================================================== -->
        <!-- Icons -->
        <!-- ===================================================== -->

        <Icon Id="AppIcon.ico" SourceFile="themes\default-icons\AppIcon.ico" />

        <!-- ===================================================== -->
        <!-- UI Configuration -->
        <!-- ===================================================== -->

        <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />

        <!-- ===================================================== -->
        <!-- Custom Actions -->
        <!-- ===================================================== -->

        <!-- Automatically launch RimSort after installation -->
        <Property Id="RIMSORTTARGET" Secure="yes" />
        <CustomAction Id="SetRimSortTarget"
            Property="RIMSORTTARGET"
            Value="[INSTALLFOLDER]RimSort.exe"
            Execute="immediate" />
        <CustomAction Id="LaunchRimSortAfterInstall"
            Property="RIMSORTTARGET"
            ExeCommand=""
            Return="asyncNoWait"
            Execute="deferred"
            Impersonate="yes" />

        <!-- ===================================================== -->
        <!-- Installation Sequence -->
        <!-- ===================================================== -->

        <InstallExecuteSequence>
            <Custom Action="SetRimSortTarget" After="InstallFiles"
                Condition="NOT Installed" />
            <Custom Action="LaunchRimSortAfterInstall" After="SetRimSortTarget"
                Condition="NOT REMOVE" />
        </InstallExecuteSequence>

        <!-- ===================================================== -->
        <!-- Directory Structure -->
        <!-- ===================================================== -->

        <StandardDirectory Id="ProgramFiles6432Folder">
            <Directory Id="INSTALLFOLDER" Name="RimSort" />
        </StandardDirectory>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="RimSortProgramMenu" Name="RimSort" />
        </StandardDirectory>

        <!-- ===================================================== -->
        <!-- Application Files -->
        <!-- ===================================================== -->

        <!-- Main application files component group -->
        <ComponentGroup Id="MainApplication" Directory="INSTALLFOLDER">
            <Files Include="$(BuildOutput)\**" />
        </ComponentGroup>

        <!-- ===================================================== -->
        <!-- Shortcuts and Start Menu -->
        <!-- ===================================================== -->

        <!-- Desktop Shortcut Component -->
        <ComponentGroup Id="DesktopShortcutComponent" Directory="DesktopFolder">
            <Component Id="DesktopShortcut" Guid="DA2459A4-6821-4143-A427-02A4786845B2">
                <Shortcut Id="ApplicationDesktopShortcut" Name="RimSort"
                    Target="[INSTALLFOLDER]RimSort.exe"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="AppIcon.ico" />
                <RegistryValue Root="HKCU" Key="Software\RimSort" Name="DesktopShortcut"
                    Type="integer" Value="1" KeyPath="yes" />
                <!-- Remove shortcut on uninstall -->
                <RemoveFolder Id="RemoveDesktopShortcut" Directory="DesktopFolder" On="uninstall" />
            </Component>
        </ComponentGroup>

        <!-- Start Menu Shortcuts Component -->
        <ComponentGroup Id="StartMenuShortcutComponent" Directory="RimSortProgramMenu">
            <Component Id="StartMenuShortcuts" Guid="AA2459A4-6821-4143-A427-02A4786845B3">
                <Shortcut Id="StartMenuShortcut" Name="RimSort"
                    Target="[INSTALLFOLDER]RimSort.exe"
                    WorkingDirectory="INSTALLFOLDER"
                    Icon="AppIcon.ico" />
                <Shortcut Id="UninstallShortcut" Name="Uninstall RimSort"
                    Target="[System64Folder]msiexec.exe"
                    Arguments="/x [ProductCode]"
                    Description="Uninstalls RimSort" />
                <RegistryValue Root="HKCU" Key="Software\RimSort" Name="StartMenuShortcut"
                    Type="integer" Value="1" KeyPath="yes" />
                <!-- Remove start menu folder on uninstall -->
                <RemoveFolder Id="RemoveStartMenuFolder" Directory="RimSortProgramMenu"
                    On="uninstall" />
            </Component>
        </ComponentGroup>

        <!-- ===================================================== -->
        <!-- Features -->
        <!-- ===================================================== -->

        <Feature Id="MainFeature" Title="RimSort" Level="1" ConfigurableDirectory="INSTALLFOLDER">
            <ComponentGroupRef Id="MainApplication" />
            <ComponentGroupRef Id="DesktopShortcutComponent" />
            <ComponentGroupRef Id="StartMenuShortcutComponent" />
        </Feature>

    </Package>

</Wix>